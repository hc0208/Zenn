---
title: "å¤–éƒ¨ã‚­ãƒ¼ã‚’å«ã‚€ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®Insertå‡¦ç†ã§ã¯é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã«FOR KEY SHAREã®è¡Œãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ãŒã‹ã‹ã‚‹"
emoji: "ğŸ”–"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["PostgreSQL"]
published: false
---
:::message
ã“ã®è¨˜äº‹ã¯æ¯é€±å¿…ãšè¨˜äº‹ãŒã§ã‚‹ãƒ†ãƒƒã‚¯ãƒ–ãƒ­ã‚° ["Loglass Tech Blog Sprint"](https://zenn.dev/loglass/articles/7298a3cd4c5fc6) ã® 5é€±ç›® ã®è¨˜äº‹ã§ã™ï¼
1å¹´é–“é€£ç¶šé”æˆã¾ã§ æ®‹ã‚Š48é€± ã¨ãªã‚Šã¾ã—ãŸï¼
:::

# èƒŒæ™¯
PostgreSQLåˆ©ç”¨æ™‚ã«å‹•ä½œç¢ºèªã‚’è¡Œãªã£ã¦ã„ãŸéš›ã«ã€ã‚ã‚‹ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ãŒä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã‚ˆã†ãªå‹•ãï¼ˆè©³ç´°ã¯å¾Œè¿°ï¼‰ã‚’ã—ã¦ã„ã‚‹ç®‡æ‰€ãŒã‚ã‚Šã¾ã—ãŸã€‚

æ„å›³çš„ã«æ’ä»–åˆ¶å¾¡ã‚’ã—ã¦ã„ã‚‹ç®‡æ‰€ã§ã¯ãªã‹ã£ãŸãŸã‚ã€è©³ç´°ã‚’èª¿ã¹ã¦ãŸã¨ã“ã‚å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ãŒé–¢é€£ã—ã¦ã„ãŸã®ã§å‹•ãã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ãŸã€‚

# ãƒãƒ¼ã‚¸ãƒ§ãƒ³
PostgreSQL 12.1

# ç’°å¢ƒæº–å‚™
ã¾ãšã€å‹•ä½œç¢ºèªã®ãŸã‚ã«ã€2ã¤ã®ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆtest_a, test_bï¼‰ã‚’ä½œæˆã—ã¾ã™ã€‚
ã“ã®ã†ã¡ã€test_bã«ã¯test_aã«å¯¾ã™ã‚‹å¤–éƒ¨ã‚­ãƒ¼ã‚’æŒãŸã›ã¦ã„ã¾ã™ã€‚

```sql
-- test_aãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
create table test_a (
  id bigserial primary key,
  name varchar(30)
);

-- test_bãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
-- test_a_idã«å¤–éƒ¨ã‚­ãƒ¼åˆ¶ç´„ã‚’è¿½åŠ 
create table test_b (
  id bigserial primary key,
  name varchar(30),
  test_a_id bigint references test_a
);
```

ãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ…‹ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢ã§ã™ã€‚
![ãƒ†ãƒ¼ãƒ–ãƒ«ã®çŠ¶æ…‹](https://storage.googleapis.com/zenn-user-upload/38e6035faa29-20230904.png)

æ¬¡ã«ã€test_aã«ã‚ã‚‰ã‹ã˜ã‚ãƒ‡ãƒ¼ã‚¿ã‚’insertã—ã¦ãŠãã¾ã™ã€‚
```sql
-- test_aãƒ†ãƒ¼ãƒ–ãƒ«ã«å€¤ã‚’æŒ¿å…¥
insert into test_a (name) values ('test_a');
```

ä¸Šè¨˜ã®å‡¦ç†ã«ã‚ˆã‚Šã€test_aã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªãƒ‡ãƒ¼ã‚¿ãŒinsertã•ã‚Œã¾ã—ãŸã€‚
```sql
select * from test_a;

/* selectã—ãŸçµæœ */
 id |  name
----+--------
  1 | test_a
(1 è¡Œ)
```

# å‹•ä½œç¢ºèª
## å‡¦ç†å¾…ã¡ã¨ãªã‚‹çŠ¶æ³ã‚’ç¢ºèª
ç’°å¢ƒã®æº–å‚™ãŒæ•´ã£ãŸã¨ã“ã‚ã§ãƒ†ãƒ¼ãƒ–ãƒ«ã®ãƒ­ãƒƒã‚¯ã®çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã„ãã¾ã™ã€‚

ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ‰‹å‹•ã§è²¼ã£ãŸçŠ¶æ…‹ã§ã€test_bã«ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’æŒ¿å…¥ã—ã¾ã™ã€‚test_a_idã«ã¯å…ˆã»ã©test_aã«insertã—ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã®idã‚’è¨­å®šã—ã¾ã™ã€‚
```sql
-- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
begin;
-- test_aã«æŒ¿å…¥ã—ãŸå€¤ã®idã‚’è¨­å®šã—ã¦æŒ¿å…¥
-- /* selectã—ãŸçµæœ */
--  id |  name
-- ----+--------
--   1 | test_a
insert into test_b (name, test_a_id) values ('test_b', 1);
```

ä¸Šè¨˜ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã¯commitã›ãšã€ã“ã®çŠ¶æ…‹ã§åˆ¥ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã§ä¾‹ãˆã°test_aã®ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã™ã‚‹å‡¦ç†ã‚’ã—ã¾ã™ã€‚
```sql
-- ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
begin;
-- test_aã«æŒ¿å…¥ã—ãŸå€¤ã®idã‚’æŒ‡å®šã—ã¦å‰Šé™¤
delete from test_a where id = 1; -- å‡¦ç†å¾…ã¡ã«ãªã‚‹
```
test_bã¸test_aã«å¯¾ã™ã‚‹å¤–éƒ¨ã‚­ãƒ¼ã‚’æŒã£ãŸãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’insertã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ã®ã§deleteæ–‡ã¯å‡¦ç†å¾…ã¡ã«ãªã‚Šã¾ã™ã€‚

## pg_locksã®çŠ¶æ³ã‚’ç¢ºèª
ä¸Šè¨˜ã§å‹•ä½œç¢ºèªã‚’è¡Œã£ãŸçŠ¶æ…‹ãŒã©ã®ã‚ˆã†ãªçŠ¶æ…‹ã¨ãªã£ã¦ã„ã‚‹ã‹pg_locksã‚’ç¢ºèªã—ã¾ã™ã€‚
ä¸Šè¨˜ã®çŠ¶æ…‹ã§ã¾ãšã€insertã—ãŸå‡¦ç†å¾Œã«pg_locksã‚’ç¢ºèªã™ã‚‹ã¨test_aã«é–¢ã—ã¦ã¯RowShareLockãŒç²å¾—ã•ã‚Œã¦ã„ã‚‹ã®ãŒã‚ã‹ã‚Šã¾ã™ã€‚
```sql
select *
from pg_locks
where pid = pg_backend_pid() AND relation = 'test_a'::regclass;

/* selectã—ãŸçµæœ */
 locktype | database | relation | page | tuple | virtualxid | transactionid | classid | objid | objsubid | virtualtransaction |  pid  |     mode     | granted | fastpath
----------+----------+----------+------+-------+------------+---------------+---------+-------+----------+--------------------+-------+--------------+---------+----------
 relation |    16391 |   163510 |      |       |            |               |         |       |          | 13/3479            | 14545 | RowShareLock | t       | t
(1 è¡Œ)
```

test_bã¸ã®ãƒ‡ãƒ¼ã‚¿insertæ™‚ã«test_aã«å¯¾ã—ã¦RowShareLockãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚

â€»ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ãƒ¢ãƒ¼ãƒ‰ã¨ã—ã¦ã¯ä»¥ä¸‹ã®ç¨®é¡ãŒå­˜åœ¨ã—ã¾ã™ãŒã€ROWã¨ã„ã†åå‰ãŒä»˜ã„ã¦ã„ã¦ã‚‚å…¨ã¦ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ãƒ™ãƒ«ã®ãƒ­ãƒƒã‚¯ãªã®ã¯æ³¨æ„ãŒå¿…è¦ã§ã™ã€‚

| ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ãƒ¢ãƒ¼ãƒ‰ |
| ---- |
| ACCESS SHARE |
| ROW SHARE |
| ROW EXCLUSIVE |
| SHARE UPDATE EXCLUSIVE |
| SHARE |
| SHARE ROW EXCLUSIVE |
| EXCLUSIVE |
| ACCESS EXCLUSIVE |

å‚è€ƒï¼š [https://www.postgresql.org/docs/12/explicit-locking.html](https://www.postgresql.org/docs/12/explicit-locking.html)


## pgrowlocksã‚’åˆ©ç”¨ã—ã¦çŠ¶æ³ã‚’ç¢ºèª
ç¶šã„ã¦ã€pgrowlocksã‚’åˆ©ç”¨ã—ã¦è¡Œãƒ¬ãƒ™ãƒ«ã®ãƒ­ãƒƒã‚¯ã®çŠ¶æ³ã‚’ç¢ºèªã§ãã‚‹ãŸã‚ãã¡ã‚‰ã§ã‚‚ç¢ºèªã‚’ã—ã¦ã¿ã¾ã™ã€‚

â€»pgrowlocksã¯CREATE EXTENSIONã§è¿½åŠ ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

insertã—ãŸå‡¦ç†å¾Œã«çµæœã‚’ç¢ºèªã™ã‚‹ã¨ä»¥ä¸‹ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
```sql
select * from pgrowlocks('test_a');

/* selectã—ãŸçµæœ */
 locked_row | locker | multi |  xids   |       modes       |  pids
------------+--------+-------+---------+-------------------+---------
 (0,1)      |  14095 | f     | {14095} | {"For Key Share"} | {14545}
(1 è¡Œ)
```

selectã—ãŸçµæœã‹ã‚‰test_aã«å¯¾ã—ã¦For Key Shareè¡Œãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ãŒã‹ã‹ã£ã¦ã„ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã—ãŸã€‚

[For Key Shareã«é–¢ã™ã‚‹ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://www.postgresql.org/docs/12/explicit-locking.html)ã‚’ç¢ºèªã™ã‚‹ã¨ã€ä»¥ä¸‹ã®ã‚ˆã†ãªè¨˜è¼‰ãŒã‚ã‚Šã€DELETEã®å‡¦ç†ã¯ä»–ã®ãƒˆãƒ©ãƒ³ã‚¶ã‚¯ã‚·ãƒ§ãƒ³ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã™ã‚‹ã¨è¨˜è¼‰ãŒã‚ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚
> FOR KEY SHARE
> Behaves similarly to FOR SHARE, except that the lock is weaker: SELECT FOR UPDATE is blocked, but not SELECT FOR NO KEY UPDATE. A key-shared lock blocks other transactions from performing DELETE or any UPDATE that changes the key values, but not other UPDATE, and neither does it prevent SELECT FOR NO KEY UPDATE, SELECT FOR SHARE, or SELECT FOR KEY SHARE.

# ã¾ã¨ã‚
å¤–éƒ¨ã‚­ãƒ¼ã‚’å«ã‚€ãƒ†ãƒ¼ãƒ–ãƒ«ã¸ã®Insertå‡¦ç†ã§ã¯é–¢é€£ãƒ†ãƒ¼ãƒ–ãƒ«ã«FOR KEY SHAREã®è¡Œãƒ¬ãƒ™ãƒ«ãƒ­ãƒƒã‚¯ãŒã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‹ã‚Šã¾ã—ãŸã€‚
æ„å›³ã—ãªã„ãƒ‡ãƒƒãƒ‰ãƒ­ãƒƒã‚¯ã®åŸå› ã«ã‚‚ãªã‚‹ãŸã‚ã“ã®è¾ºã‚Šã®å‹•ãã¯æ„è­˜ã—ã¦ãŠããŸã„ã¨ã“ã‚ã§ã™ã€‚

# å‚è€ƒ
[PostgreSQL 12 Documentation](https://www.postgresql.org/docs/12/)
